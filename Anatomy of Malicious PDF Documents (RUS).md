# Анатомия вредоносных PDF-документов
**Дидьер Стивенс**
*Увеличение количества вредоносных PDF-документов породило интерес к способам анализа таких документов*

Эта статья научит вас анализировать конкретный класс вредоносных PDF-документов: те из них, которые используют уязвимость во встроенном интерпретаторе Java Script. Но помимо этого класса, полученные знания помогут вам с анализом и других классов документов, например, тех, в которых используется уязвимость PDF-парсера. Также, несмотря на тот факт, что большинство атак нацелено на ОС Windows, рассмотренные здесь проблемы равнозначно относятся и к документам, отрендеренным в других операционках, таких как Linux или OSX.

## Hello world в PDF
Давайте начнем с создания вручную самого простейшего PDF-документа из одной страницы с текстом "Hello world". Несмотря на то, что вы не найдете подобного документа в окружающем вас пространстве, для наших нужд он очень подходит: объяснит внутреннее строение PDF-документа. Он содержит только основные элементы, необходимые для отображения страницы, и отформатирован для лучшей читаемости. Одной из его особенностей является то, что он содержит только символы ANCII, что делает его читаемым в любом простейшем текстовом редакторе, таком как Блокнот. Другой его характеристикой является содержание большого количества лишних пробелов и отступов, добавленных для лучшей демонстрации структуры PDF. И наконец, содержимое его не было сжато.

### Заголовок
Каждый PDF-документ должен начинаться с одной строки, магической цифры, идентифицирующей файл как PDF-документ. Она так же определяет версию спецификации, используемую для расшифровки документа.
`%PDF-1.1`
Любая строка, начинающаяся с символа %, в документе является строкой комментария и её содержимое игнорируется за двумя исключениями:
Начало документа: %PDF-X.Y
Конец документа: %%EOF

### Объекты
Сразу за нашей первой строкой мы начинаем добавлять объекты (собранные из простейших элементов языка PDF) к нашему документу. Порядок, в котором эти объекты присутствуют в файле, не влияет на верстку страницы. Но для наглядности, мы будет представлять их в логическом порядке. Одна важная ремарка: язык PDF чувствителен к регистру. Наш первый объект - это каталог. Он говорит приложению, производящему рендеринг документа (такому как Adobe Acrobat Reader), где искать объекты, из которых собран документ.
```
1 0 obj
<<
 /Type /Catalog
 /Outlines 2 0 R
 /Pages 3 0 R
>>
endobj
```
Это, вообще-то, косвенный объект, поскольку имеет номер, на который можно ссылаться. Синтаксис прост: номер, версия, слово obj, непосредственно объект и слово endobj. Комбинация номера объекта и его версии позволяет уникально определять этот объект. Тип нашего первого объекта, каталога, - справочник. Справочники очень распространены в PDF-документах. Они начинаются со знака `<<` и заканчиваются знаком `>>`:
```
<<
    содержимое справочника
>>
```
Элементы в справочнике состоят из ключа и значения. Справочник может содержать элементы, объекты или другие справочники. Большинство словарей объявляют свой тип с помощью фразы `/Type (ключ)`, затем следует имя самого типа. В нашем случае, `/Catalog`.
```
/Type /Catalog
```
Объект "Catalog" должен содержать Аутлайны (рамки) и Страницы, имеющиеся в PDF.
```
 /Outlines 2 0 R
 /Pages 3 0 R
```
2 0 R и 3 0 R - это ссылки на косвенные объекты 2 и 3. Косвенный объект 2 описывает аутлайн, косвенный объект 3 описывает страницы.
Итак, давайте добавим наш второй косвенный объект в наш PDF-документ:
```
2 0 obj
<<
 /Type /Outlines
 /Count 0
>>
endobj
```
С учетом тех комментариев, которые сопровождали создание объекта 1, вы должны понять синтаксис создания этого объекта. Этот объект - справочник с типом `/Outlines`. Он имеет `/Count of 0`, что означает, что рамки для документа отсутствуют. На этот объект можно ссылаться используя его номер и версию: 2 и 0. 
Давайте подытожим, что у нас уже есть в нашем PDF-документе: 
- строка, идентифицирующая PDF-документ
- косвенный объект 1
- косвенный объект 2
Перед тем, как мы будем добавлять страницу с текстом, давайте изобразим другую особенность языка PDF. Наш объект каталога 1 ссылается на наш объект 2 
![Figure 1](/illustrations/pdf01.png)